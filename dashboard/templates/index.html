<!-- dashboard/templates/index.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Trading Bot Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <style>
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Helvetica Neue',Arial; margin:0; background:#0f172a; color:#e5e7eb; }
    header { display:flex; align-items:center; justify-content:space-between; padding:16px 20px; border-bottom:1px solid #1f2937; }
    .title { font-weight:700; letter-spacing:.3px; }
    .sub { font-size:12px; opacity:.8; }
    .badge { padding:6px 10px; border-radius:999px; font-size:12px; font-weight:600; display:inline-flex; align-items:center; gap:8px; }
    .ok { background:rgba(34,197,94,.12); color:#22c55e; border:1px solid rgba(34,197,94,.3); }
    .err { background:rgba(239,68,68,.12); color:#ef4444; border:1px solid rgba(239,68,68,.3); }
    .wrap { display:flex; gap:16px; padding:16px; }
    .left { width:70%; }
    .right { width:30%; }
    .card { background:#111827; border:1px solid #1f2937; border-radius:12px; padding:14px; }
    table { width:100%; border-collapse:collapse; font-size:13px; }
    th, td { padding:8px 10px; border-bottom:1px dashed #1f2937; }
    th { text-align:left; color:#9ca3af; font-weight:600; }
    .footer { display:flex; gap:12px; align-items:center; }
    .pill { padding:4px 8px; border-radius:999px; background:#0b1220; border:1px solid #1f2937; font-size:12px; color:#9ca3af;}
    .btn { padding:8px 12px; border-radius:10px; font-weight:600; border:1px solid #1f2937; background:#0b1220; color:#e5e7eb; cursor:pointer;}
    .btn:hover { background:#0f1627; }
    .muted { color:#9ca3af; font-size:12px; }
    canvas { width:100%; height:320px; background:#0b1220; border:1px solid #1f2937; border-radius:12px; }
  </style>
</head>
<body>
  <header>
    <div>
      <div class="title">Trading Bot — Dashboard</div>
      <div class="sub">
        Status indicator, last refresh timestamp (UTC), trades table & equity chart
      </div>
    </div>
    <div style="display:flex; align-items:center; gap:12px;">
      <div id="statusBadge" class="badge err">STOPPED</div>
      <div class="pill">Last refresh (UTC): <span id="lastRefresh">—</span></div>
      <a class="btn" href="/export/trades.csv">Export CSV</a>
    </div>
  </header>

  <div class="wrap">
    <div class="left">
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
          <div class="title" style="font-size:14px;">Trades</div>
          <div class="muted" id="tradesMeta">—</div>
        </div>
        <div style="overflow:auto; max-height:65vh;">
          <table id="tradesTable">
            <thead>
              <tr>
                <th>Time (UTC)</th><th>Connector</th><th>Symbol</th><th>Type</th>
                <th>Side</th><th>Price</th><th>Qty</th><th>PnL</th><th>Equity</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="right">
      <div class="card" style="margin-bottom:16px;">
        <div class="title" style="font-size:14px; margin-bottom:8px;">Equity</div>
        <canvas id="eqChart"></canvas>
        <div class="footer" style="margin-top:8px;">
          <span class="muted">Auto refresh every 10s</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    async function fetchData() {
      const res = await fetch('/data', {cache:'no-store'});
      if (!res.ok) return null;
      return await res.json();
    }

    function fmt(x, d=2) {
      if (x === "" || x === null || x === undefined) return "";
      const n = Number(x);
      return isFinite(n) ? n.toFixed(d) : x;
    }

    function setStatus(status, lastTs) {
      const el = document.getElementById('statusBadge');
      el.textContent = status;
      el.className = 'badge ' + (status === 'RUNNING' ? 'ok' : 'err');
      document.getElementById('lastRefresh').textContent = lastTs || '—';
    }

    function renderTrades(list) {
      const tb = document.querySelector('#tradesTable tbody');
      tb.innerHTML = '';
      for (const r of list.slice(-500).reverse()) { // מציג 500 אחרונים
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.time ?? ''}</td>
          <td>${r.connector ?? ''}</td>
          <td>${r.symbol ?? ''}</td>
          <td>${r.type ?? ''}</td>
          <td>${r.side ?? ''}</td>
          <td>${fmt(r.price, 6)}</td>
          <td>${fmt(r.qty, 6)}</td>
          <td>${fmt(r.pnl, 2)}</td>
          <td>${fmt(r.equity, 2)}</td>
        `;
        tb.appendChild(tr);
      }
      document.getElementById('tradesMeta').textContent =
        `${list.length} trades total (${Math.min(500, list.length)} shown)`;
    }

    // Equity “poor man chart”
    function renderEquity(eq) {
      const canvas = document.getElementById('eqChart');
      const ctx = canvas.getContext('2d');
      const w = canvas.clientWidth, h = canvas.clientHeight;
      const scale = window.devicePixelRatio || 1;
      canvas.width = Math.floor(w * scale);
      canvas.height = Math.floor(h * scale);
      ctx.scale(scale, scale);
      ctx.clearRect(0, 0, w, h);

      const vals = eq.map(e => Number(e.equity)).filter(v => isFinite(v));
      if (vals.length < 2) {
        ctx.fillStyle = '#9ca3af';
        ctx.fillText('Not enough data', 10, 20);
        return;
      }
      const min = Math.min(...vals), max = Math.max(...vals);
      const pad = 10;
      const xStep = (w - pad*2) / (vals.length - 1);
      function y(v){ return pad + (h - pad*2) * (1 - (v - min) / Math.max(1e-9, (max - min))); }

      ctx.beginPath();
      ctx.lineWidth = 2;
      ctx.strokeStyle = '#22c55e';
      vals.forEach((v,i) => {
        const x = pad + i * xStep;
        const yy = y(v);
        if (i === 0) ctx.moveTo(x, yy);
        else ctx.lineTo(x, yy);
      });
      ctx.stroke();
    }

    async function tick() {
      try {
        const d = await fetchData();
        if (!d) return;
        setStatus(d.status, d.now_utc);
        renderTrades(d.trades || []);
        renderEquity(d.equity || []);
      } catch (e) {
        console.error(e);
      }
    }

    tick();
    setInterval(tick, 10000);
  </script>
</body>
</html>
