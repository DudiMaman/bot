<!-- dashboard/templates/index.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Trading Bot Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <style>
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Helvetica Neue',Arial; margin:0; background:#0f172a; color:#e5e7eb; }
    header { display:flex; align-items:center; justify-content:space-between; padding:16px 20px; border-bottom:1px solid #1f2937; }
    .title { font-weight:700; letter-spacing:.3px; }
    .sub { font-size:12px; opacity:.8; }
    .badge { padding:6px 10px; border-radius:999px; font-size:12px; font-weight:600; display:inline-flex; align-items:center; gap:8px; }
    .ok { background:rgba(34,197,94,.12); color:#22c55e; border:1px solid rgba(34,197,94,.3); }
    .err { background:rgba(239,68,68,.12); color:#ef4444; border:1px solid rgba(239,68,68,.3); }
    .wrap { display:flex; gap:16px; padding:16px; }
    .left { width:70%; }
    .right { width:30%; }
    .card { background:#111827; border:1px solid #1f2937; border-radius:12px; padding:14px; }
    table { width:100%; border-collapse:collapse; font-size:13px; }
    th, td { padding:8px 10px; border-bottom:1px dashed #1f2937; }
    th { text-align:left; color:#9ca3af; font-weight:600; }
    .footer { display:flex; gap:12px; align-items:center; }
    .pill { padding:4px 8px; border-radius:999px; background:#0b1220; border:1px solid #1f2937; font-size:12px; color:#9ca3af;}
    .btn { padding:8px 12px; border-radius:10px; font-weight:600; border:1px solid #1f2937; background:#0b1220; color:#e5e7eb; cursor:pointer;}
    .btn:hover { background:#0f1627; }
    .muted { color:#9ca3af; font-size:12px; }
    canvas { width:100%; height:320px; background:#0b1220; border:1px solid #1f2937; border-radius:12px; }
  </style>
</head>
<body>
<header>
  <div>
    <div class="title">Trading Bot — Dashboard</div>
    <div class="sub">Status indicator, last refresh timestamp (UTC), trades table & equity chart</div>
  </div>

  <div style="display:flex; align-items:center; gap:12px;">
    <!-- Badge סטטוס מאוחד: מקבל RUNNING/STOPPED + מקור (db/csv) -->
    <span id="status-badge" class="badge err" aria-live="polite" title="Unified status from /api/status">
      Loading…
    </span>

    <!-- עדכון טיימסטמפּ אחרון -->
    <div class="pill">Last refresh (UTC): <span id="lastRefresh">—</span></div>

    <!-- ייצוא -->
    <a class="btn" href="/export/trades.csv">Export CSV</a>
  </div>
</header>

<div class="wrap">
  <div class="left">
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
        <div class="title" style="font-size:14px;">Trades</div>
        <div class="muted" id="tradesMeta">—</div>
      </div>
      <div style="overflow:auto; max-height:65vh;">
        <table id="tradesTable">
          <thead>
            <tr>
              <th>Time (UTC)</th><th>Connector</th><th>Symbol</th><th>Type</th>
              <th>Side</th><th>Price</th><th>Qty</th><th>PnL</th><th>Equity</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="right">
    <div class="card" style="margin-bottom:16px;">
      <div class="title" style="font-size:14px; margin-bottom:8px;">Equity</div>
      <canvas id="eqChart"></canvas>
      <div class="footer" style="margin-top:8px;">
        <span class="muted">Auto refresh every 10s</span>
      </div>
    </div>
  </div>
</div>

<script>
/* ===== Helpers ===== */
function fmtNum(n, d=2) {
  if (n === null || n === undefined || n === '') return '—';
  const x = Number(n);
  if (!Number.isFinite(x)) return String(n);
  return x.toLocaleString('en-US', { maximumFractionDigits: d });
}

function setStatusBadge(status, source, ageSec, lastISO) {
  const badge = document.getElementById('status-badge');
  const lastRefresh = document.getElementById('lastRefresh');
  if (!badge) return;
  const ok = String(status).toUpperCase() === 'RUNNING';
  badge.classList.remove('ok','err');
  badge.classList.add(ok ? 'ok' : 'err');
  const age = (ageSec != null) ? ` • ${ageSec}s` : '';
  badge.textContent = `${ok ? 'RUNNING' : 'STOPPED'} (${source || '?'})${age}`;
  if (lastRefresh) lastRefresh.textContent = lastISO || '—';
}

/* ===== Rendering ===== */
function renderTrades(list) {
  const tb = document.querySelector('#tradesTable tbody');
  const meta = document.getElementById('tradesMeta');
  if (!tb) return;
  tb.innerHTML = '';
  // מציג עד 500 אחרונות, חדשות למעלה
  const rows = (list || []).slice(0, 500);
  for (const r of rows) {
    const tr = document.createElement('tr');
    const side = String(r.side || '').toUpperCase();
    const sideColor = side === 'LONG' ? '#22c55e' : side === 'SHORT' ? '#60a5fa' : '#e5e7eb';
    tr.innerHTML = `
      <td>${r.time ?? ''}</td>
      <td>${r.connector ?? ''}</td>
      <td>${r.symbol ?? ''}</td>
      <td>${r.type ?? ''}</td>
      <td style="color:${sideColor}; font-weight:600">${side || '—'}</td>
      <td style="text-align:right">${fmtNum(r.price, 8)}</td>
      <td style="text-align:right">${fmtNum(r.qty, 6)}</td>
      <td style="text-align:right">${fmtNum(r.pnl, 2)}</td>
      <td style="text-align:right">${fmtNum(r.equity, 2)}</td>
    `;
    tb.appendChild(tr);
  }
  if (meta) meta.textContent = `rows: ${rows.length} • updated: ${new Date().toISOString()}`;
}

function renderEquity(eq) {
  const canvas = document.getElementById('eqChart');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const w = canvas.clientWidth, h = canvas.clientHeight;
  const scale = window.devicePixelRatio || 1;
  canvas.width = Math.floor(w * scale);
  canvas.height = Math.floor(h * scale);
  ctx.scale(scale, scale);
  ctx.clearRect(0, 0, w, h);

  const vals = (eq || []).map(e => Number(e.equity)).filter(v => Number.isFinite(v));
  if (vals.length < 2) {
    ctx.fillStyle = '#9ca3af';
    ctx.fillText('Not enough data', 10, 20);
    return;
  }
  const min = Math.min(...vals), max = Math.max(...vals);
  const pad = 10;
  const xStep = (w - pad*2) / Math.max(1, (vals.length - 1));
  function y(v){ return pad + (h - pad*2) * (1 - (v - min) / Math.max(1e-9, (max - min))); }

  ctx.beginPath();
  ctx.lineWidth = 2;
  ctx.strokeStyle = '#22c55e';
  vals.forEach((v,i) => {
    const x = pad + i * xStep;
    const yy = y(v);
    if (i === 0) ctx.moveTo(x, yy);
    else ctx.lineTo(x, yy);
  });
  ctx.stroke();
}

/* ===== Data fetchers (unified APIs) ===== */
async function fetchStatus() {
  const r = await fetch('/api/status', { cache: 'no-store' });
  if (!r.ok) throw new Error('status HTTP ' + r.status);
  return r.json(); // {status, source, age_sec, last_update}
}

async function fetchData() {
  const r = await fetch('/api/data', { cache: 'no-store' });
  if (!r.ok) throw new Error('data HTTP ' + r.status);
  return r.json(); // {status,last_update,age_sec,source,now_utc,equity,trades}
}

/* ===== Tick loop ===== */
async function tick() {
  try {
    const [st, data] = await Promise.all([fetchStatus(), fetchData()]);
    setStatusBadge(st.status, st.source, st.age_sec, st.last_update);
    renderTrades(data.trades || []);
    renderEquity(data.equity || []);
  } catch (e) {
    console.error('tick error:', e);
    // הורד סטטוס כדי לסמן תקלה רגעית ב-UI
    setStatusBadge('STOPPED', 'error', null, '—');
  }
}

tick();
setInterval(tick, 10000); // רענון כל 10 שניות
</script>
</body>
</html>
